name: ğŸš€ deploy

on:
  push:
    branches:
      - develop
      - main
      - 231-bug-deploy-ìˆ˜ì •
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1ï¸âƒ£ í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (ë¸Œëœì¹˜ë³„ prod/dev êµ¬ë¶„)
      - name: Set environment variables
        run: |
          echo "==== í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì‹œì‘ ===="
          if [[ ${{ github.ref }} == 'refs/heads/main' ]]; then
            echo "ENV_TYPE=prod" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.PROD_EC2_HOST }}" >> $GITHUB_ENV
            echo "APPLICATION_YML=${{ secrets.PROD_APPLICATION_YML }}" >> $GITHUB_ENV
            echo "SENTRY_ENVIRONMENT=production" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=luckeat-prod" >> $GITHUB_ENV
            echo "í™˜ê²½: prod ì„¤ì • ì™„ë£Œ"
          else
            echo "ENV_TYPE=dev" >> $GITHUB_ENV
            echo "EC2_HOST=${{ secrets.DEV_EC2_HOST }}" >> $GITHUB_ENV
            echo "APPLICATION_YML=${{ secrets.DEV_APPLICATION_YML }}" >> $GITHUB_ENV
            echo "SENTRY_ENVIRONMENT=development" >> $GITHUB_ENV
            echo "ECR_REPOSITORY=luckeat-dev" >> $GITHUB_ENV
            echo "í™˜ê²½: dev ì„¤ì • ì™„ë£Œ"
          fi
          echo "==== í™˜ê²½ ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ ===="

      # 2ï¸âƒ£ GitHubì—ì„œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 3ï¸âƒ£ JDK 21 ì„¤ì •
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 4ï¸âƒ£ Sentry ë¦´ë¦¬ì¦ˆ ìƒì„±
      - name: Create Sentry release
        uses: getsentry/action-release@v1
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ktb-sh
          SENTRY_PROJECT: sentry-back
        with:
          environment: ${{ env.SENTRY_ENVIRONMENT }}
          version: ${{ github.sha }}
          ignore_missing: true
          ignore_empty: true

      # 5ï¸âƒ£ AWS ìê²©ì¦ëª… êµ¬ì„±
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 6ï¸âƒ£ ECR ë¡œê·¸ì¸
      - name: Login to ECR
        run: |
          echo "==== ECR ë¡œê·¸ì¸ ì‹œì‘ ===="
          aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
          echo "==== ECR ë¡œê·¸ì¸ ì™„ë£Œ ===="

      # 7ï¸âƒ£ Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Build and push Docker image
        run: |
          echo "==== Docker ì´ë¯¸ì§€ ë¹Œë“œ ì‹œì‘ ===="
          # ì´ë¯¸ì§€ ë¹Œë“œ
          docker build -t ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.TAG }} --build-arg SPRING_PROFILES_ACTIVE=${{ env.ENV_TYPE }} .
          echo "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          
          # ì´ë¯¸ì§€ í‘¸ì‹œ
          echo "==== ì´ë¯¸ì§€ í‘¸ì‹œ ì‹œì‘ ===="
          docker push ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.TAG }}
          echo "ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ"
          echo "==== Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ ì™„ë£Œ ===="

      # 8ï¸âƒ£ SSH í‚¤ ì¤€ë¹„
      - name: Prepare SSH Key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" | base64 --decode > key.pem
          chmod 600 key.pem

      # 9ï¸âƒ£ EC2ì— SSH ì ‘ì† ë° ë°°í¬
      - name: SSH into EC2 and Deploy
        run: |
          HOST=${{ env.EC2_HOST }}
          USER=${{ secrets.EC2_USER }}
          TAG=${{ env.TAG }}
          
          echo "ğŸ¯ í˜„ì¬ ë°°í¬í•  íƒœê·¸: $TAG"
          ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST "TAG=$TAG bash -s" << EOF
            set -e
          
            echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸"
            ACTIVE_CONTAINER=\$(docker ps --format '{{.Names}}' | grep -E 'blue-[12]|green-[12]' | head -n 1 || echo 'blue-1')
            
            if [[ "\$ACTIVE_CONTAINER" == "blue-1" || "\$ACTIVE_CONTAINER" == "blue-2" ]]; then
                NEW_VERSION="green"
                OLD_VERSION="blue"
            else
                NEW_VERSION="blue"
                OLD_VERSION="green"
            fi
        
            echo "ğŸ” í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ: \$ACTIVE_CONTAINER"
            echo "ğŸ”„ ë‹¤ìŒ ë°°í¬í•  ì»¨í…Œì´ë„ˆ ê·¸ë£¹: \$NEW_VERSION"
            
            echo "ğŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ë°°í¬: \$NEW_VERSION"
            echo "âœ… ì‚¬ìš©ë˜ëŠ” ì´ë¯¸ì§€ íƒœê·¸: \$TAG"
            
            # ECR ë¡œê·¸ì¸
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}
            
            # ìƒˆë¡œìš´ ì´ë¯¸ì§€ pull
            docker pull ${{ secrets.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:\$TAG
        
            echo "ğŸ’¾ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë¡œë“œ"
            aws ssm get-parameter --name ${{ secrets.PARAMETER_NAME }} --with-decryption --query 'Parameter.Value' --output text > env_file
        
            echo "ğŸ“¦ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            docker-compose pull \${NEW_VERSION}-1 \${NEW_VERSION}-2
            docker-compose up -d --no-deps --force-recreate --remove-orphans --build \${NEW_VERSION}-1 \${NEW_VERSION}-2
            
            echo "â³ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ëŒ€ê¸°"
            sleep 30
            
            echo "ğŸ” ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸"
            NEW_CONTAINER_STATUS=\$(docker ps --filter "name=\${NEW_VERSION}" --format "{{.Status}}")
            if [[ "\$NEW_CONTAINER_STATUS" == *"Up"* ]]; then
                echo "âœ… ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì •ìƒ ì‹¤í–‰"
                
                echo "ğŸ—‘ï¸ ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬"
                docker-compose stop \${OLD_VERSION}-1 \${OLD_VERSION}-2
                docker-compose rm -f \${OLD_VERSION}-1 \${OLD_VERSION}-2
                
                echo "ğŸ‰ ë°°í¬ ì™„ë£Œ"
            else
                echo "âŒ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì‹¤íŒ¨"
                exit 1
            fi
          EOF
